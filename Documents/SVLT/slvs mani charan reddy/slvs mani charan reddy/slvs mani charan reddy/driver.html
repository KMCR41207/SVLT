<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetFlow - Driver Dashboard</title>
    <link rel="stylesheet" href="animated-bg.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: transparent; min-height: 100vh; overflow-y: auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 100; }
        .header h1 { font-size: 1.8rem; }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 0.5rem 1.5rem; border-radius: 6px; cursor: pointer; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; position: relative; z-index: 1; }
        .welcome { background: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #ddd; }
        .tab { padding: 1rem 2rem; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .load-card { border: 1px solid #ddd; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; background: #fafafa; }
        .load-card h3 { margin-bottom: 0.5rem; color: #333; }
        .load-card p { margin: 0.3rem 0; color: #666; }
        .btn { padding: 0.6rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .empty-state { text-align: center; padding: 3rem; color: #999; }
        .back-btn-corner { position: fixed; top: auto; bottom: 2rem; left: 2rem; z-index: 1000; }
        .back-btn-corner button { background: rgba(255, 255, 255, 0.9); color: #667eea; border: 1px solid rgba(102, 126, 234, 0.3); padding: 0.6rem 1.2rem; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); transition: all 0.3s; }
        .back-btn-corner button:hover { background: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); transform: translateX(-3px); }
        .dashboard-dropdown { position: relative; display: inline-block; margin-top: 0.5rem; z-index: 10000; }
        .dashboard-btn { display: inline-block; padding: 0.5rem 1.2rem; background: rgba(255, 255, 255, 0.2); color: white; text-decoration: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s; }
        .dashboard-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .dropdown-content { display: none; position: absolute; top: calc(100% + 0.5rem); left: 0; background: white; min-width: 220px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); border-radius: 6px; z-index: 10001; }
        .dropdown-content.show { display: block; }
        .dropdown-content a { color: #333; padding: 0.8rem 1rem; text-decoration: none; display: block; transition: 0.3s; border-bottom: 1px solid #f0f0f0; }
        .dropdown-content a:first-child { border-radius: 6px 6px 0 0; }
        .dropdown-content a:last-child { border-bottom: none; border-radius: 0 0 6px 6px; }
        .dropdown-content a:hover { background: #f5f5f5; color: #667eea; }
    </style>
</head>
<body>
    <div class="animated-gradient-bg"></div>
    
    <div class="back-btn-corner">
        <button onclick="goBack()">‚Üê Back</button>
    </div>
    
    <div class="header">
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <h1>üöõ FleetFlow - Driver Dashboard</h1>
            <div class="dashboard-dropdown">
                <div class="dashboard-btn" onclick="toggleDropdown(event)">
                    üìã Options ‚ñº
                </div>
                <div class="dropdown-content" id="dropdownMenu">
                    <a href="welcome.html">üè† Home</a>
                    <a href="#" onclick="switchTab('available-loads'); return false;">üì¶ Available Loads</a>
                    <a href="#" onclick="switchTab('my-trips'); return false;">üöó My Trips</a>
                    <a href="#" onclick="switchTab('earnings'); return false;">üí∞ Earnings</a>
                </div>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <div class="welcome">
            <h2>Welcome, <span id="userName">Driver</span>!</h2>
            <p>Manage your loads, trips, and earnings from your dashboard.</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('available-loads')">Available Loads</button>
            <button class="tab" onclick="switchTab('my-trips')">My Trips</button>
            <button class="tab" onclick="switchTab('earnings')">Earnings</button>
        </div>

        <div id="available-loads" class="tab-content active">
            <h2>Available Loads</h2>
            <div id="loadsList"></div>
        </div>

        <div id="my-trips" class="tab-content">
            <h2>My Trips</h2>
            <div id="tripsList"></div>
        </div>

        <div id="earnings" class="tab-content">
            <h2>Earnings & Payments</h2>
            <div id="paymentsList"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:3000/api';
        let token = localStorage.getItem('token');

        if (!token) {
            window.location.href = 'auth.html';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'available-loads') loadAvailableLoads();
            if (tabName === 'my-trips') loadMyTrips();
            if (tabName === 'earnings') loadEarnings();
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'auth.html';
        }

        function goBack() {
            window.history.back();
        }

        function toggleDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.dashboard-btn')) {
                const dropdowns = document.getElementsByClassName('dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    dropdowns[i].classList.remove('show');
                }
            }
        }

        async function loadUserInfo() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await res.json();
                document.getElementById('userName').textContent = user.name || user.email;
            } catch (err) {
                console.error('Failed to load user info:', err);
            }
        }

        async function loadAvailableLoads() {
            try {
                const res = await fetch(`${API_URL}/loads?status=open`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const loads = await res.json();
                const container = document.getElementById('loadsList');
                
                if (loads.length === 0) {
                    container.innerHTML = '<div class="empty-state">No available loads at the moment.</div>';
                    return;
                }

                container.innerHTML = loads.map(load => `
                    <div class="load-card">
                        <h3>${load.title}</h3>
                        <p><strong>From:</strong> ${load.pickup_location}</p>
                        <p><strong>To:</strong> ${load.delivery_location}</p>
                        <p><strong>Weight:</strong> ${load.weight_tons} tons</p>
                        <p><strong>Price:</strong> $${load.price_fixed || 'Negotiable'}</p>
                        <button class="btn btn-primary" onclick="applyForLoad('${load.id}')">Apply for Load</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load available loads:', err);
                document.getElementById('loadsList').innerHTML = '<div class="empty-state">Failed to load data.</div>';
            }
        }

        async function applyForLoad(loadId) {
            try {
                const res = await fetch(`${API_URL}/loads/${loadId}/bids`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: 'I am interested in this load' })
                });
                
                if (res.ok) {
                    alert('Application submitted successfully!');
                    loadAvailableLoads();
                } else {
                    alert('Failed to apply for load');
                }
            } catch (err) {
                console.error('Failed to apply:', err);
                alert('Error applying for load');
            }
        }

        async function loadMyTrips() {
            try {
                const res = await fetch(`${API_URL}/trips`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const trips = await res.json();
                const container = document.getElementById('tripsList');
                
                if (trips.length === 0) {
                    container.innerHTML = '<div class="empty-state">No trips yet.</div>';
                    return;
                }

                container.innerHTML = trips.map(trip => `
                    <div class="load-card">
                        <h3>Trip #${trip.id.substring(0, 8)}</h3>
                        <p><strong>Status:</strong> ${trip.status}</p>
                        <p><strong>Started:</strong> ${trip.start_time || 'Not started'}</p>
                        ${trip.status === 'assigned' ? `<button class="btn btn-success" onclick="updateTripStatus('${trip.id}', 'picked_up')">Mark as Picked Up</button>` : ''}
                        ${trip.status === 'picked_up' ? `<button class="btn btn-success" onclick="updateTripStatus('${trip.id}', 'in_transit')">Mark as In Transit</button>` : ''}
                        ${trip.status === 'in_transit' ? `<button class="btn btn-success" onclick="updateTripStatus('${trip.id}', 'delivered')">Mark as Delivered</button>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load trips:', err);
                document.getElementById('tripsList').innerHTML = '<div class="empty-state">Failed to load data.</div>';
            }
        }

        async function updateTripStatus(tripId, status) {
            try {
                const res = await fetch(`${API_URL}/trips/${tripId}/status`, {
                    method: 'PATCH',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                if (res.ok) {
                    alert('Trip status updated!');
                    loadMyTrips();
                } else {
                    alert('Failed to update trip status');
                }
            } catch (err) {
                console.error('Failed to update:', err);
                alert('Error updating trip status');
            }
        }

        async function loadEarnings() {
            try {
                const res = await fetch(`${API_URL}/payments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const payments = await res.json();
                const container = document.getElementById('paymentsList');
                
                if (payments.length === 0) {
                    container.innerHTML = '<div class="empty-state">No payment records yet.</div>';
                    return;
                }

                const total = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
                container.innerHTML = `
                    <div class="load-card">
                        <h3>Total Earnings: $${total.toFixed(2)}</h3>
                    </div>
                    ${payments.map(payment => `
                        <div class="load-card">
                            <p><strong>Amount:</strong> $${payment.amount}</p>
                            <p><strong>Status:</strong> ${payment.status}</p>
                            <p><strong>Date:</strong> ${new Date(payment.created_at).toLocaleDateString()}</p>
                        </div>
                    `).join('')}
                `;
            } catch (err) {
                console.error('Failed to load earnings:', err);
                document.getElementById('paymentsList').innerHTML = '<div class="empty-state">Failed to load data.</div>';
            }
        }

        // Initialize
        loadUserInfo();
        loadAvailableLoads();
    </script>
</body>
</html>
